---
globs: src/server/services/*Schema*.ts,src/server/services/*Truncate*.ts,schemas/**/*
description: Regras para geraÃ§Ã£o de schemas Zod, truncamento e organizaÃ§Ã£o de arquivos
---

# Regras de GeraÃ§Ã£o e OrganizaÃ§Ã£o de Schemas

## âœ‚ï¸ Truncamento de Campos Grandes

### Campos que DEVEM ser truncados:
- `base64` - Dados de imagem em base64
- `JPEGThumbnail` - Thumbnails JPEG
- `thumbnail` - Qualquer tipo de thumbnail
- `data` - Campos de dados grandes
- `image` - Dados de imagem

### ConfiguraÃ§Ã£o de Truncamento:
```typescript
// âœ… Correto - ConfiguraÃ§Ã£o padrÃ£o
private readonly config: TruncateConfig = {
  maxLength: 100,
  fields: ['base64', 'JPEGThumbnail', 'thumbnail', 'data', 'image'],
  preserveStructure: true
};
```

### MarcaÃ§Ã£o de Campos Truncados:
- SEMPRE adicionar `[TRUNCATED]` no final
- Preservar inÃ­cio do campo para anÃ¡lise de tipo
- Salvar metadata sobre truncamento
- Manter exemplos completos em `raw-samples/`

```typescript
// âœ… Correto - String truncada
"data": "iVBORw0KGgoAAAANSUhEUgAA...[TRUNCATED]"
```

## ğŸ“ OrganizaÃ§Ã£o de Arquivos Gerados

### Estrutura OBRIGATÃ“RIA para cada tipo de evento:
```
schemas/
â”œâ”€â”€ Message/
â”‚   â”œâ”€â”€ schema.zod.ts      # Schema Zod principal
â”‚   â”œâ”€â”€ interface.ts       # Interface TypeScript
â”‚   â”œâ”€â”€ examples.json      # Exemplos truncados
â”‚   â”œâ”€â”€ metadata.json      # Metadados e estatÃ­sticas
â”‚   â””â”€â”€ raw-samples/       # Amostras completas
â”‚       â”œâ”€â”€ sample-001.json
â”‚       â””â”€â”€ sample-002.json
â””â”€â”€ Picture/
    â”œâ”€â”€ schema.zod.ts
    â”œâ”€â”€ interface.ts
    â””â”€â”€ ...
```

### Nomenclatura dos Arquivos:
- Nome da pasta: PascalCase (`Message`, `BusinessName`)
- Arquivos de schema: sempre `schema.zod.ts`
- Interface: sempre `interface.ts`
- Samples: formato `sample-{timestamp}.json`

## ğŸ¯ GeraÃ§Ã£o de Schema Zod

### PadrÃµes ObrigatÃ³rios:
```typescript
// âœ… Correto - Schema Zod com comentÃ¡rios
import { z } from 'zod';

export const MessageSchema = z.object({
  eventType: z.string(),
  body: z.object({
    data: z.string().describe('TRUNCATED FIELD - Original type: base64'),
    timestamp: z.number()
  })
});

export type Message = z.infer<typeof MessageSchema>;
```

### Campos Opcionais vs ObrigatÃ³rios:
- Campo aparece em TODOS os eventos â†’ ObrigatÃ³rio
- Campo aparece em ALGUNS eventos â†’ `.optional()`
- NUNCA assumir obrigatoriedade sem evidÃªncia

### ComentÃ¡rios Descritivos:
- Campos truncados DEVEM ter `.describe()` com tipo original
- Exemplos de valores quando possÃ­vel
- Indicar se campo Ã© calculado ou vem do webhook

## ğŸ” DetecÃ§Ã£o e ComparaÃ§Ã£o de Estruturas

### Hash de Estrutura:
- NUNCA incluir valores no hash
- APENAS estrutura: tipos, opcionalidade, aninhamento
- Hash SHA-256 da estrutura normalizada
- Usado para deduplicaÃ§Ã£o automÃ¡tica

### Merge de Estruturas:
```typescript
// âœ… Correto - Merge preservando opcionalidade
if (existingField && newField) {
  // Campo existe em ambos
  merged.children.set(key, this.mergeStructures(existing, new));
} else if (existingField) {
  // Campo sÃ³ no existente â†’ marca como opcional
  existingField.optional = true;
}
```

## ğŸ“Š Metadata e EstatÃ­sticas

### Formato metadata.json:
```json
{
  "eventType": "Message",
  "firstSeen": "2024-01-01T00:00:00.000Z",
  "lastSeen": "2024-01-01T12:00:00.000Z", 
  "totalReceived": 150,
  "schemaVersion": 3,
  "fields": {
    "required": ["eventType", "body.timestamp"],
    "optional": ["body.data"],
    "truncated": ["body.image", "body.thumbnail"]
  },
  "variations": [
    {
      "hash": "abc123...",
      "count": 120,
      "description": "VersÃ£o com thumbnail"
    }
  ]
}
```

## ğŸ§¹ Limpeza e ManutenÃ§Ã£o

### Limite de Amostras:
- MÃ¡ximo 10 samples por tipo de evento
- Remover samples mais antigos automaticamente
- Manter pelo menos 1 sample sempre

### Limite de Exemplos:
- MÃ¡ximo 20 exemplos no metadata
- Rotacionar exemplos (FIFO)
- Preservar diversidade de estruturas

## ğŸ”„ Versionamento de Schemas

### Quando Incrementar VersÃ£o:
- Nova propriedade obrigatÃ³ria detectada
- MudanÃ§a de tipo de campo existente
- RemoÃ§Ã£o de propriedade anteriormente obrigatÃ³ria

### Quando NÃƒO Incrementar:
- Apenas novos valores para campos existentes
- Nova propriedade opcional
- Campos truncados com tamanhos diferentes

## âš¡ Performance

### OtimizaÃ§Ãµes ObrigatÃ³rias:
- Processar schema generation em queue worker
- Cache de estruturas jÃ¡ processadas
- Evitar re-parsing de arquivos grandes
- Batch de mÃºltiplas mudanÃ§as de schema

### Limites de Recursos:
- MÃ¡ximo 100MB por payload
- Timeout de 30s para anÃ¡lise de estrutura
- MÃ¡ximo 1000 propriedades por objeto